<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.busan.orora.review.mapper.ReviewMapper">
    
    <resultMap id="ReviewResultMap" type="com.busan.orora.review.dto.ReviewDto">
        <id property="id" column="id" />
        <result property="userId" column="user_id" />
        <result property="touristSpotId" column="tourist_spot_id" />
        <result property="title" column="title" />
        <result property="content" column="content" />
        <result property="rating" column="rating" />
        <result property="isApproved" column="is_approved" />
        <result property="createdAt" column="created_at" />
        <result property="updatedAt" column="updated_at" />
    </resultMap>

    <!-- 관광지별 리뷰 조회 (사용자 정보, 좋아요 수, 댓글 수 포함) -->
    <select id="findReviewsBySpotId" resultType="java.util.HashMap" parameterType="Long">
        SELECT 
            r.id,
            r.user_id as userId,
            r.tourist_spot_id as touristSpotId,
            r.title,
            r.content,
            r.rating,
            r.is_approved as isApproved,
            r.created_at as createdAt,
            r.updated_at as updatedAt,
            u.username as userName,
            COALESCE(upi.image_url, '/images/defaultProfile.png') as userProfileImage,
            COALESCE(like_count.likes, 0) as likes,
            COALESCE(comment_count.comments, 0) as replies
        FROM reviews r
        LEFT JOIN users u ON r.user_id = u.id
        LEFT JOIN user_profile_images upi ON u.id = upi.user_id AND upi.id = (
            SELECT id FROM user_profile_images 
            WHERE user_id = u.id 
            ORDER BY reg_time DESC 
            LIMIT 1
        )
        LEFT JOIN (
            SELECT review_id, COUNT(*) as likes
            FROM review_likes
            GROUP BY review_id
        ) like_count ON r.id = like_count.review_id
        LEFT JOIN (
            SELECT review_id, COUNT(*) as comments
            FROM review_comments
            WHERE is_approved = TRUE
            GROUP BY review_id
        ) comment_count ON r.id = comment_count.review_id
        WHERE r.tourist_spot_id = #{spotId}
          AND r.is_approved = TRUE
        ORDER BY r.created_at DESC
    </select>

    <!-- 리뷰 이미지 조회 -->
    <select id="findReviewImagesByReviewId" resultType="java.util.HashMap" parameterType="Long">
        SELECT 
            id,
            review_id as reviewId,
            image_url as imageUrl,
            image_order as imageOrder,
            alt_text as altText,
            created_at as createdAt
        FROM review_images
        WHERE review_id = #{reviewId}
        ORDER BY image_order ASC
    </select>

    <!-- 사용자별 리뷰 조회 -->
    <select id="findReviewsByUserId" resultMap="ReviewResultMap" parameterType="Long">
        SELECT 
            id,
            user_id,
            tourist_spot_id,
            title,
            content,
            rating,
            is_approved,
            created_at,
            updated_at
        FROM reviews
        WHERE user_id = #{userId}
          AND is_approved = TRUE
        ORDER BY created_at DESC
    </select>

    <!-- 사용자별 리뷰 조회 (관광지 정보 포함) -->
    <select id="findReviewsByUserIdWithSpotInfo" resultType="java.util.HashMap" parameterType="Long">
        SELECT 
            r.id,
            r.user_id as userId,
            r.tourist_spot_id as touristSpotId,
            r.title,
            r.content,
            r.rating,
            r.is_approved as isApproved,
            r.created_at as createdAt,
            r.updated_at as updatedAt,
            ts.title as touristSpotName,
            ts.title as tourist_spot_name
        FROM reviews r
        LEFT JOIN tourist_spots ts ON r.tourist_spot_id = ts.id
        WHERE r.user_id = #{userId}
          AND r.is_approved = TRUE
        ORDER BY r.created_at DESC
    </select>

    <!-- 사용자가 좋아요 누른 리뷰 조회 -->
    <select id="findLikedReviewsByUserId" resultType="java.util.HashMap" parameterType="Long">
        SELECT 
            r.id,
            r.user_id as userId,
            r.tourist_spot_id as touristSpotId,
            r.title,
            r.content,
            r.rating,
            r.is_approved as isApproved,
            r.created_at as createdAt,
            r.updated_at as updatedAt,
            ts.title as touristSpotName,
            ts.title as tourist_spot_name,
            u.username as authorName,
            u.username as author_name,
            rl.created_at as likedAt
        FROM review_likes rl
        INNER JOIN reviews r ON rl.review_id = r.id
        LEFT JOIN tourist_spots ts ON r.tourist_spot_id = ts.id
        LEFT JOIN users u ON r.user_id = u.id
        WHERE rl.user_id = #{userId}
          AND r.is_approved = TRUE
        ORDER BY rl.created_at DESC
    </select>

    <!-- 리뷰 ID로 조회 -->
    <select id="findReviewById" resultMap="ReviewResultMap" parameterType="Long">
        SELECT 
            id,
            user_id,
            tourist_spot_id,
            title,
            content,
            rating,
            is_approved,
            created_at,
            updated_at
        FROM reviews
        WHERE id = #{id}
    </select>

    <!-- 리뷰 작성 -->
    <insert id="insertReview" parameterType="com.busan.orora.review.dto.ReviewDto" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO reviews (user_id, tourist_spot_id, title, content, rating, is_approved)
        VALUES (#{userId}, #{touristSpotId}, #{title}, #{content}, #{rating}, COALESCE(#{isApproved}, TRUE))
    </insert>

    <!-- 리뷰 이미지 저장 -->
    <insert id="insertReviewImage" parameterType="java.util.HashMap">
        INSERT INTO review_images (review_id, image_url, image_order, alt_text)
        VALUES (#{reviewId}, #{imageUrl}, #{imageOrder}, #{altText})
    </insert>

    <!-- 리뷰 이미지 삭제 -->
    <delete id="deleteReviewImage" parameterType="Long">
        DELETE FROM review_images
        WHERE id = #{imageId}
    </delete>

    <!-- 리뷰 수정 -->
    <update id="updateReview" parameterType="com.busan.orora.review.dto.ReviewDto">
        UPDATE reviews
        SET title = #{title},
            content = #{content},
            rating = #{rating},
            updated_at = CURRENT_TIMESTAMP
        WHERE id = #{id}
    </update>

    <!-- 리뷰 삭제 -->
    <delete id="deleteReview" parameterType="Long">
        DELETE FROM reviews
        WHERE id = #{id}
    </delete>

    <!-- 관광지별 평균 평점 조회 -->
    <select id="getAverageRating" resultType="Double" parameterType="Long">
        SELECT COALESCE(AVG(rating), 0.0) as averageRating
        FROM reviews
        WHERE tourist_spot_id = #{spotId}
          AND is_approved = TRUE
    </select>

    <!-- 관광지별 평점 개수 조회 -->
    <select id="getRatingCount" resultType="Integer" parameterType="Long">
        SELECT COUNT(*) as ratingCount
        FROM reviews
        WHERE tourist_spot_id = #{spotId}
          AND is_approved = TRUE
    </select>

    <!-- 여러 관광지의 평점 통계 배치 조회 -->
    <select id="getRatingStatsBySpotIds" resultType="java.util.HashMap" parameterType="list">
        SELECT tourist_spot_id AS touristSpotId,
               COALESCE(AVG(rating), 0.0) AS ratingAvg,
               COUNT(*) AS ratingCount
        FROM reviews
        WHERE is_approved = TRUE
          AND tourist_spot_id IN
        <foreach item="id" collection="spotIds" open="(" separator="," close=")">
            #{id}
        </foreach>
        GROUP BY tourist_spot_id
    </select>

    <!-- 신고 목록 조회 (관리자용) - 신고자, 피신고자(리뷰 작성자), 신고 내용 포함 -->
    <select id="findAllReports" resultType="java.util.HashMap">
        SELECT 
            rr.id,
            rr.user_id as reporterId,
            rr.review_id as reviewId,
            rr.reason,
            rr.status_code as statusCode,
            rr.created_at as createdAt,
            rr.updated_at as updatedAt,
            reporter.username as reporterName,
            reporter.login_id as reporterLoginId,
            review_author.id as reportedUserId,
            review_author.username as reportedUserName,
            review_author.login_id as reportedUserLoginId,
            r.title as reviewTitle,
            r.content as reviewContent
        FROM review_reports rr
        LEFT JOIN users reporter ON rr.user_id = reporter.id
        LEFT JOIN reviews r ON rr.review_id = r.id
        LEFT JOIN users review_author ON r.user_id = review_author.id
        ORDER BY rr.created_at DESC
    </select>

    <!-- 리뷰별 댓글 목록 조회 -->
    <select id="findCommentsByReviewId" resultType="java.util.HashMap" parameterType="Long">
        SELECT 
            rc.id,
            rc.user_id as userId,
            rc.review_id as reviewId,
            rc.content,
            rc.is_approved as isApproved,
            rc.created_at as createdAt,
            rc.updated_at as updatedAt,
            u.username as userName,
            u.login_id as userLoginId,
            COALESCE(upi.image_url, '/images/defaultProfile.png') as userProfileImage
        FROM review_comments rc
        LEFT JOIN users u ON rc.user_id = u.id
        LEFT JOIN user_profile_images upi ON u.id = upi.user_id AND upi.id = (
            SELECT id FROM user_profile_images 
            WHERE user_id = u.id 
            ORDER BY reg_time DESC 
            LIMIT 1
        )
        WHERE rc.review_id = #{reviewId}
          AND rc.is_approved = TRUE
        ORDER BY rc.created_at ASC
    </select>

    <!-- 댓글 작성 -->
    <insert id="insertComment">
        INSERT INTO review_comments (user_id, review_id, content, is_approved)
        VALUES (#{userId}, #{reviewId}, #{content}, TRUE)
    </insert>

    <!-- 댓글 수정 -->
    <update id="updateComment">
        UPDATE review_comments
        SET content = #{content}, updated_at = NOW()
        WHERE id = #{commentId} AND user_id = #{userId}
    </update>

    <!-- 댓글 삭제 -->
    <delete id="deleteComment">
        DELETE FROM review_comments
        WHERE id = #{commentId} AND user_id = #{userId}
    </delete>

    <!-- 댓글 작성자 확인 -->
    <select id="findCommentUserId" resultType="Long">
        SELECT user_id
        FROM review_comments
        WHERE id = #{commentId}
    </select>

    <!-- 댓글 신고 -->
    <insert id="insertCommentReport">
        INSERT INTO comment_reports (user_id, comment_id, reason, status_code)
        VALUES (#{userId}, #{commentId}, #{reason}, 'PENDING')
    </insert>

    <!-- 댓글 신고 목록 조회 (관리자용) - 신고자, 피신고자(댓글 작성자), 신고 내용 포함 -->
    <select id="findAllCommentReports" resultType="java.util.HashMap">
        SELECT 
            cr.id,
            cr.user_id as reporterId,
            cr.comment_id as commentId,
            cr.reason,
            cr.status_code as statusCode,
            cr.created_at as createdAt,
            cr.updated_at as updatedAt,
            reporter.username as reporterName,
            reporter.login_id as reporterLoginId,
            comment_author.id as reportedUserId,
            comment_author.username as reportedUserName,
            comment_author.login_id as reportedUserLoginId,
            rc.content as commentContent,
            r.id as reviewId,
            r.title as reviewTitle
        FROM comment_reports cr
        LEFT JOIN users reporter ON cr.user_id = reporter.id
        LEFT JOIN review_comments rc ON cr.comment_id = rc.id
        LEFT JOIN users comment_author ON rc.user_id = comment_author.id
        LEFT JOIN reviews r ON rc.review_id = r.id
        ORDER BY cr.created_at DESC
    </select>

    <!-- 리뷰 신고 -->
    <insert id="insertReviewReport">
        INSERT INTO review_reports (user_id, review_id, reason, status_code)
        VALUES (#{userId}, #{reviewId}, #{reason}, 'PENDING')
    </insert>

    <!-- 리뷰 신고 상태 업데이트 -->
    <update id="updateReviewReportStatus">
        UPDATE review_reports 
        SET status_code = #{statusCode}, updated_at = NOW()
        WHERE id = #{reportId}
    </update>

    <!-- 리뷰 신고 삭제 -->
    <delete id="deleteReviewReport">
        DELETE FROM review_reports WHERE id = #{reportId}
    </delete>

    <!-- 댓글 신고 상태 업데이트 -->
    <update id="updateCommentReportStatus">
        UPDATE comment_reports 
        SET status_code = #{statusCode}, updated_at = NOW()
        WHERE id = #{reportId}
    </update>

    <!-- 댓글 신고 삭제 -->
    <delete id="deleteCommentReport">
        DELETE FROM comment_reports WHERE id = #{reportId}
    </delete>

    <!-- 리뷰 신고 ID로 reviewId 조회 -->
    <select id="findReviewIdByReportId" resultType="Long">
        SELECT review_id 
        FROM review_reports 
        WHERE id = #{reportId}
    </select>

    <!-- 댓글 신고 ID로 commentId 조회 -->
    <select id="findCommentIdByReportId" resultType="Long">
        SELECT comment_id 
        FROM comment_reports 
        WHERE id = #{reportId}
    </select>

    <!-- 리뷰 신고 중복 확인 -->
    <select id="findReviewReportByUserAndReview" resultType="Long">
        SELECT id 
        FROM review_reports 
        WHERE user_id = #{userId} AND review_id = #{reviewId}
        LIMIT 1
    </select>

    <!-- 댓글 신고 중복 확인 -->
    <select id="findCommentReportByUserAndComment" resultType="Long">
        SELECT id 
        FROM comment_reports 
        WHERE user_id = #{userId} AND comment_id = #{commentId}
        LIMIT 1
    </select>

    <!-- 사용자별 댓글 조회 (리뷰 및 관광지 정보 포함) -->
    <select id="findCommentsByUserId" resultType="java.util.HashMap" parameterType="Long">
        SELECT 
            rc.id,
            rc.user_id as userId,
            rc.review_id as reviewId,
            rc.content,
            rc.is_approved as isApproved,
            rc.created_at as createdAt,
            rc.updated_at as updatedAt,
            r.title as reviewTitle,
            r.content as reviewContent,
            ts.id as touristSpotId,
            ts.title as touristSpotName,
            u.username as reviewAuthorName
        FROM review_comments rc
        INNER JOIN reviews r ON rc.review_id = r.id
        LEFT JOIN tourist_spots ts ON r.tourist_spot_id = ts.id
        LEFT JOIN users u ON r.user_id = u.id
        WHERE rc.user_id = #{userId}
          AND rc.is_approved = TRUE
          AND r.is_approved = TRUE
        ORDER BY rc.created_at DESC
    </select>

</mapper>
