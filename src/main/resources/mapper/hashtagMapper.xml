<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.busan.orora.hashtag.mapper.HashtagMapper">
    <resultMap id="HashtagResultMap" type="com.busan.orora.hashtag.dto.HashtagDto">
        <id property="id" column="id" />
        <result property="name" column="name" />
        <result property="createdAt" column="created_at" />
        <result property="touristSpotId" column="tourist_spot_id" />
    </resultMap>

    <!-- 모든 해시태그 조회 -->
    <select id="findAllHashtags" resultMap="HashtagResultMap">
        SELECT id, name, created_at
        FROM hashtags
        ORDER BY name ASC
    </select>

    <!-- ID로 해시태그 조회 -->
    <select id="findHashtagById" resultMap="HashtagResultMap" parameterType="Long">
        SELECT id, name, created_at
        FROM hashtags
        WHERE id = #{id}
    </select>

    <!-- 이름으로 해시태그 조회 -->
    <select id="findHashtagByName" resultMap="HashtagResultMap" parameterType="String">
        SELECT id, name, created_at
        FROM hashtags
        WHERE name = #{name}
    </select>

    <!-- 관광지 ID로 해시태그 목록 조회 -->
    <select id="findHashtagsBySpotId" resultMap="HashtagResultMap" parameterType="Long">
        SELECT h.id, h.name, h.created_at
        FROM hashtags h
        INNER JOIN tourist_spot_hashtags tsh ON h.id = tsh.hashtag_id
        WHERE tsh.tourist_spot_id = #{spotId}
        ORDER BY h.name ASC
    </select>

    <!-- 여러 관광지 ID로 해시태그 목록 배치 조회 -->
    <select id="findHashtagsBySpotIds" resultMap="HashtagResultMap" parameterType="list">
        SELECT h.id, h.name, h.created_at, tsh.tourist_spot_id AS touristSpotId
        FROM hashtags h
        INNER JOIN tourist_spot_hashtags tsh ON h.id = tsh.hashtag_id
        WHERE tsh.tourist_spot_id IN
        <foreach item="id" collection="spotIds" open="(" separator="," close=")">
            #{id}
        </foreach>
        ORDER BY tsh.tourist_spot_id, h.name ASC
    </select>

    <!-- 해시태그 추가 -->
    <insert id="insertHashtag" parameterType="com.busan.orora.hashtag.dto.HashtagDto" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO hashtags (name, created_at)
        VALUES (#{name}, #{createdAt})
    </insert>

    <!-- 관광지-해시태그 연결 추가 -->
    <insert id="insertSpotHashtag">
        INSERT INTO tourist_spot_hashtags (tourist_spot_id, hashtag_id)
        VALUES (#{spotId}, #{hashtagId})
    </insert>

    <!-- 관광지의 모든 해시태그 연결 삭제 -->
    <delete id="deleteSpotHashtags" parameterType="Long">
        DELETE FROM tourist_spot_hashtags
        WHERE tourist_spot_id = #{spotId}
    </delete>


    <!-- 여기서부터 작업 -->
    <select id="selectTouristSpotHashtags" resultType="com.busan.orora.hashtag.dto.HashtagDto">
        SELECT  t.id AS id,
                GROUP_CONCAT(DISTINCT tsi.image_url SEPARATOR ', ') AS imageUrl,
                t.title, 
                t.description, 
                GROUP_CONCAT(h.name SEPARATOR ', ') AS hashtagList,
                r.name AS regionsName
        FROM tourist_spots t    JOIN tourist_spot_hashtags tsh ON t.id = tsh.tourist_spot_id
                                JOIN hashtags h ON tsh.hashtag_id = h.id
                                JOIN regions r ON t.region_id = r.id
                                JOIN tourist_spot_images tsi ON t.id = tsi.tourist_spot_id
        GROUP BY t.id, t.title, t.description, r.name
        ORDER BY t.title ASC
    </select>
</mapper>
